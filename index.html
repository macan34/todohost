<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TodoPro Enhanced - Kolaborasi Tim yang Disempurnakan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.15);
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --assignment-color: #8b5cf6;
    }

    [data-theme="dark"] {
      --bg-primary: #1e293b;
      --bg-secondary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #475569;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      line-height: 1.5;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      min-height: 120px;
      position: relative;
    }

    header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 300;
      letter-spacing: -1px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      position: relative;
    }

    .sound-toggle, .theme-toggle, .saved-rooms-toggle {
      position: absolute;
      top: 2rem;
    }

    .sound-toggle { left: 2rem; }
    .theme-toggle { right: 2rem; }
    .saved-rooms-toggle { right: 5rem; }

    .sound-toggle button, .theme-toggle button, .saved-rooms-toggle button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }

    .sound-toggle button:hover, .theme-toggle button:hover, .saved-rooms-toggle button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .card {
      background: var(--bg-primary);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: var(--shadow-medium);
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: all 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.45);
    }

    .card h2, .card h3 {
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .stat-item {
      text-align: center;
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 8px;
      box-shadow: var(--shadow-light);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .member-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .member-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-secondary);
      padding: 0.5rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      border: 1px solid var(--border-color);
    }

    .member-chip.mentor {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .member-chip .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
    }

    .member-chip .status-dot.offline {
      background: #6b7280;
    }

    .assignment-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: #f3e8ff;
      color: var(--assignment-color);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #ddd6fe;
      margin-right: 0.5rem;
    }

    .notification-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 400px;
    }

    .notification-toast {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow-medium);
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .notification-toast.success {
      border-color: var(--success-color);
      background: #f0fdf4;
      color: #065f46;
    }

    .notification-toast.error {
      border-color: var(--danger-color);
      background: #fef2f2;
      color: #991b1b;
    }

    .notification-toast.warning {
      border-color: var(--warning-color);
      background: #fffbeb;
      color: #92400e;
    }

    .priority-high {
      border-left: 4px solid var(--danger-color);
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
    }

    .priority-medium {
      border-left: 4px solid var(--warning-color);
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent);
    }

    .priority-low {
      border-left: 4px solid var(--success-color);
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
    }

    .priority-overdue {
      border-left: 4px solid #dc2626;
      background: linear-gradient(90deg, rgba(220, 38, 38, 0.15), transparent);
      animation: urgentPulse 2s infinite;
    }

    .priority-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      margin-right: 0.5rem;
    }

    .priority-badge.high {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .priority-badge.medium {
      background: #fffbeb;
      color: #d97706;
      border: 1px solid #fde68a;
    }

    .priority-badge.low {
      background: #f0fdf4;
      color: #059669;
      border: 1px solid #bbf7d0;
    }

    .priority-badge.overdue {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    .due-date-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: #f0f4ff;
      color: #667eea;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #c7d2fe;
      margin-right: 0.5rem;
    }

    .due-date-badge.overdue {
      background: #fef2f2;
      color: #dc2626;
      border-color: #fca5a5;
      animation: urgentPulse 2s infinite;
    }

    .due-date-badge.today {
      background: #fffbeb;
      color: #d97706;
      border-color: #fde68a;
    }

    .due-date-badge.tomorrow {
      background: #f0fdf4;
      color: #059669;
      border-color: #bbf7d0;
    }

    .todo-section {
      margin-bottom: 2rem;
    }

    .todo-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .todo-section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .todo-section-count {
      background: var(--primary-gradient);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .todo-section-count.completed {
      background: var(--success-color);
    }

    .todo-section-count.overdue {
      background: var(--danger-color);
      animation: urgentPulse 2s infinite;
    }

    .todo-item {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-color);
      position: relative;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .todo-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    .todo-item.completed {
      background: #f0f9ff;
      border-color: var(--success-color);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    .todo-item strong {
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
    }

    input[type="text"], input[type="datetime-local"], select, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }

    input[type="text"]:focus, input[type="datetime-local"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status.online {
      background: var(--success-color);
      color: white;
    }

    .status.offline {
      background: var(--danger-color);
      color: white;
    }

    .hidden { 
      display: none; 
    }

    .auth-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    @media (min-width: 480px) {
      .auth-buttons {
        flex-direction: row;
        align-items: center;
      }
      
      .auth-buttons button {
        flex: 1;
      }
      
      .auth-buttons input {
        flex: 2;
        margin: 0 0.5rem;
      }
    }

    .add-todo-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .add-todo-form input, .add-todo-form select, .add-todo-form textarea {
      margin-bottom: 0;
    }

    .add-todo-form .full-width {
      grid-column: 1 / -1;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .modal-content {
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: var(--shadow-medium);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .modal-close {
      background: var(--danger-color);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      padding: 0;
    }

    .room-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .room-item:hover {
      background: var(--bg-secondary);
      transform: translateY(-1px);
    }

    .room-info h4 {
      margin: 0 0 0.25rem 0;
      color: var(--text-primary);
    }

    .room-info small {
      color: var(--text-secondary);
    }

    @keyframes urgentPulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @media (max-width: 768px) {
      .container { padding: 0 1rem; }
      .card { padding: 1rem; }
      header h1 { font-size: 2rem; }
      .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
      .add-todo-form { grid-template-columns: 1fr; }
      .sound-toggle, .theme-toggle, .saved-rooms-toggle { top: 1rem; }
      .sound-toggle { left: 1rem; }
      .theme-toggle { right: 1rem; }
      .saved-rooms-toggle { right: 4rem; }
    }
  </style>
</head>

<body>
  <header>
    <h1>📝 TodoPro Enhanced</h1>
    <div class="sound-toggle">
      <button id="soundToggle" onclick="toggleSound()">🔊</button>
    </div>
    <div class="saved-rooms-toggle">
      <button id="savedRoomsToggle" onclick="showSavedRooms()">📚</button>
    </div>
    <div class="theme-toggle">
      <button id="themeToggle" onclick="toggleTheme()">🌙</button>
    </div>
  </header>

  <div class="notification-container" id="notificationContainer"></div>

  <div class="container">
    <!-- Session Restore Modal -->
    <div id="restoreModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>🔄 Restore Session</h3>
          <button class="modal-close" onclick="closeRestoreModal()">×</button>
        </div>
        <p>Ditemukan session sebelumnya. Ingin melanjutkan?</p>
        <div id="restoreSessionInfo"></div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button onclick="restoreSession()" style="flex: 1;">✅ Ya, Lanjutkan</button>
          <button onclick="closeRestoreModal()" style="flex: 1; background: var(--danger-color);">❌ Mulai Baru</button>
        </div>
      </div>
    </div>

    <!-- Saved Rooms Modal -->
    <div id="savedRoomsModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>📚 Saved Rooms</h3>
          <button class="modal-close" onclick="closeSavedRoomsModal()">×</button>
        </div>
        <div id="savedRoomsList"></div>
      </div>
    </div>

    <div id="authSection" class="card">
      <h2>🚀 Mari Berkolaborasi</h2>
      <div id="sessionStatus" class="hidden" style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bae6fd;">
        <p style="color: #0369a1; margin: 0; font-size: 0.9rem;">
          💾 <strong>Auto-save aktif:</strong> Data tersimpan otomatis setiap 10 detik
        </p>
      </div>
      <input type="text" id="userName" placeholder="Masukkan nama Anda">
      <div class="auth-buttons">
        <button onclick="createRoom()">🎯 Buat Room (Mentor)</button>
        <input type="text" id="roomIdInput" placeholder="Room ID untuk bergabung">
        <button onclick="joinRoom()">🤝 Gabung Room (Member)</button>
      </div>
    </div>

    <div id="app" class="hidden">
      <div class="card">
        <h3>📈 Dashboard Analitik</h3>
        <div class="dashboard-stats">
          <div class="stat-item">
            <div class="stat-number" id="totalTasks">0</div>
            <div class="stat-label">Total Tugas</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="completedTasks">0</div>
            <div class="stat-label">Selesai</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="completionRate">0%</div>
            <div class="stat-label">Tingkat Penyelesaian</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="overdueTasks">0</div>
            <div class="stat-label">Terlambat</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="assignedToMe">0</div>
            <div class="stat-label">Tugas Saya</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 id="roomTitle">🏠 Room</h2>
        <p id="userRole" style="color: #667eea; font-weight: 500;"></p>
        <p style="margin-top: 0.5rem;">Status: <span id="status" class="status offline">Offline</span></p>
        
        <div style="margin-top: 1rem;">
          <h4 style="color: var(--text-primary); margin-bottom: 0.5rem;">👥 Anggota</h4>
          <div class="member-list" id="memberList"></div>
        </div>
      </div>

      <div class="card">
        <input type="text" id="searchInput" placeholder="🔍 Cari tugas..." onkeyup="filterTasks()">
        <select id="assigneeFilter" onchange="filterTasks()">
          <option value="all">Semua Penugasan</option>
          <option value="assigned-to-me">Ditugaskan ke Saya</option>
          <option value="unassigned">Belum Ditugaskan</option>
        </select>
      </div>

      <div id="todoSection" class="card">
        <h3>📋 Daftar Tugas</h3>
        
        <div id="addTodoForm" class="add-todo-form hidden">
          <input type="text" id="todoTitle" placeholder="Judul tugas...">
          <textarea id="todoDesc" placeholder="Deskripsi tugas..." rows="2"></textarea>
          
          <select id="todoPriority">
            <option value="low">🟢 Prioritas Rendah</option>
            <option value="medium" selected>🟡 Prioritas Sedang</option>
            <option value="high">🔴 Prioritas Tinggi</option>
          </select>
          
          <input type="datetime-local" id="todoDueDate" placeholder="Batas waktu...">
          
          <select id="todoAssignee">
            <option value="">👥 Tugaskan ke Semua Anggota</option>
            <option value="unassigned">⚪ Biarkan Tidak Ditugaskan</option>
          </select>
          
          <button onclick="addTodo()" class="full-width">➕ Tambah Tugas</button>
        </div>
        
        <div id="memberInfo" class="hidden" style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #bae6fd;">
          <p style="color: #0369a1; margin: 0 0 0.5rem 0; font-size: 0.9rem;">
            💡 <strong>Anggota:</strong> Periksa tugas yang ditugaskan kepada Anda!
          </p>
          <p style="color: #0369a1; margin: 0; font-size: 0.85rem; font-style: italic;">
            📋 Mentor hanya memantau progres dan tidak perlu melakukan checklist.
          </p>
        </div>
        
        <div id="todoList">
          <div id="overdueSection" class="todo-section">
            <div class="todo-section-header">
              <div class="todo-section-title">⚠️ Tugas Terlambat</div>
              <span id="overdueCount" class="todo-section-count overdue">0</span>
            </div>
            <div id="overdueTasks"></div>
          </div>

          <div id="inboxSection" class="todo-section">
            <div class="todo-section-header">
              <div class="todo-section-title">📥 Kotak Masuk (Tugas Aktif)</div>
              <span id="inboxCount" class="todo-section-count">0</span>
            </div>
            <div id="inboxTasks"></div>
          </div>

          <div id="completedSection" class="todo-section">
            <div class="todo-section-header">
              <div class="todo-section-title">✅ Tugas Selesai</div>
              <span id="completedCount" class="todo-section-count completed">0</span>
            </div>
            <div id="completedTasks"></div>
          </div>

          <div class="empty-state" id="emptyState">
            <p>Belum ada tugas</p>
            <small>Mentor akan menambahkan tugas untuk Anda!</small>
          </div>
        </div>
      </div>

      <button onclick="logout()" style="background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%); width: 100%; margin-top: 1rem;">🚪 Keluar Room</button>
    </div>
  </div>

  <script>
    // ===== FIXED WINDOW VARIABLES =====
    window.peer = null;
    window.conn = null;
    window.connections = [];
    window.userName = "";
    window.roomId = "";
    window.role = "";
    window.roomMembers = new Map();
    window.soundEnabled = true;
    window.autoSaveInterval = null;

    // ===== STORAGE MANAGER =====
    window.storageManager = {
      saveSession: function(sessionData) {
        try {
          const sessions = this.getSessions();
          sessions[window.roomId] = {
            ...sessionData,
            lastSaved: new Date().toISOString(),
            roomId: window.roomId
          };
          localStorage.setItem('todopro_sessions', JSON.stringify(sessions));
          console.log('Session saved for room:', window.roomId);
        } catch (error) {
          console.error('Error saving session:', error);
        }
      },

      getSessions: function() {
        try {
          return JSON.parse(localStorage.getItem('todopro_sessions') || '{}');
        } catch (error) {
          console.error('Error loading sessions:', error);
          return {};
        }
      },

      getSession: function(roomId) {
        const sessions = this.getSessions();
        return sessions[roomId] || null;
      },

      deleteSession: function(roomId) {
        try {
          const sessions = this.getSessions();
          delete sessions[roomId];
          localStorage.setItem('todopro_sessions', JSON.stringify(sessions));
        } catch (error) {
          console.error('Error deleting session:', error);
        }
      },

      getCurrentSession: function() {
        return {
          userName: window.userName,
          roomId: window.roomId,
          role: window.role,
          todos: loadTodos(),
          members: Array.from(window.roomMembers.entries()),
          timestamp: new Date().toISOString()
        };
      }
    };

    // ===== ENHANCED DOM READY HANDLING =====
    function initializeApp() {
      try {
        // Check for existing session
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        
        if (roomFromUrl) {
          checkForExistingSession(roomFromUrl);
        } else {
          checkForExistingSession();
        }

        // Initialize theme
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          document.documentElement.setAttribute("data-theme", savedTheme);
          updateThemeToggle();
        }
        
        // Initialize sound
        window.soundEnabled = localStorage.getItem("soundEnabled") !== "false";
        updateSoundToggle();
        
        // Request notification permission
        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission();
        }

        // Show session status
        document.getElementById("sessionStatus").classList.remove("hidden");

      } catch (error) {
        console.error('Error initializing app:', error);
      }
    }

    // ===== SESSION MANAGEMENT =====
    function checkForExistingSession(roomId = null) {
      const sessions = window.storageManager.getSessions();
      const sessionKeys = Object.keys(sessions);
      
      if (sessionKeys.length === 0) return;
      
      let sessionToRestore = null;
      
      if (roomId && sessions[roomId]) {
        sessionToRestore = sessions[roomId];
      } else {
        // Find most recent session
        sessionToRestore = sessionKeys.reduce((latest, key) => {
          const session = sessions[key];
          return (!latest || new Date(session.lastSaved) > new Date(latest.lastSaved)) ? session : latest;
        }, null);
      }
      
      if (sessionToRestore) {
        showRestoreModal(sessionToRestore);
      }
    }

    function showRestoreModal(session) {
      const modal = document.getElementById('restoreModal');
      const info = document.getElementById('restoreSessionInfo');
      
      info.innerHTML = `
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <p><strong>Room:</strong> ${session.roomId}</p>
          <p><strong>Nama:</strong> ${session.userName}</p>
          <p><strong>Role:</strong> ${session.role}</p>
          <p><strong>Tugas:</strong> ${session.todos ? session.todos.length : 0}</p>
          <p><strong>Terakhir disimpan:</strong> ${new Date(session.lastSaved).toLocaleString('id-ID')}</p>
        </div>
      `;
      
      modal.classList.remove('hidden');
      window.currentRestoreSession = session;
    }

    function restoreSession() {
      const session = window.currentRestoreSession;
      if (!session) return;
      
      try {
        window.userName = session.userName;
        window.roomId = session.roomId;
        window.role = session.role;
        
        // Restore todos
        if (session.todos) {
          localStorage.setItem('todos', JSON.stringify(session.todos));
        }
        
        // Restore members
        if (session.members) {
          window.roomMembers.clear();
          session.members.forEach(([name, data]) => {
            window.roomMembers.set(name, data);
          });
        }
        
        closeRestoreModal();
        setupApp();
        showNotification('Session berhasil dipulihkan!', 'success');
        
        // Try to reconnect
        if (window.role === 'mentor') {
          autoCreateRoom();
        } else {
          autoJoinRoom();
        }
        
      } catch (error) {
        console.error('Error restoring session:', error);
        showNotification('Gagal memulihkan session', 'error');
        closeRestoreModal();
      }
    }

    function closeRestoreModal() {
      document.getElementById('restoreModal').classList.add('hidden');
      window.currentRestoreSession = null;
    }

    // ===== SAVED ROOMS MANAGEMENT =====
    function showSavedRooms() {
      const modal = document.getElementById('savedRoomsModal');
      const list = document.getElementById('savedRoomsList');
      const sessions = window.storageManager.getSessions();
      
      list.innerHTML = '';
      
      if (Object.keys(sessions).length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Belum ada room yang tersimpan</p>';
      } else {
        Object.entries(sessions).forEach(([roomId, session]) => {
          const item = document.createElement('div');
          item.className = 'room-item';
          item.innerHTML = `
            <div class="room-info">
              <h4>${roomId}</h4>
              <small>${session.userName} (${session.role}) - ${session.todos ? session.todos.length : 0} tugas</small>
              <br><small>Terakhir: ${new Date(session.lastSaved).toLocaleString('id-ID')}</small>
            </div>
            <div>
              <button onclick="loadSavedRoom('${roomId}')" style="margin-right: 0.5rem; padding: 0.5rem;">📂 Load</button>
              <button onclick="deleteSavedRoom('${roomId}')" style="background: var(--danger-color); padding: 0.5rem;">🗑️</button>
            </div>
          `;
          list.appendChild(item);
        });
      }
      
      modal.classList.remove('hidden');
    }

    function loadSavedRoom(roomId) {
      const session = window.storageManager.getSession(roomId);
      if (session) {
        window.currentRestoreSession = session;
        closeSavedRoomsModal();
        restoreSession();
      }
    }

    function deleteSavedRoom(roomId) {
      if (confirm(`Hapus room ${roomId} dari penyimpanan?`)) {
        window.storageManager.deleteSession(roomId);
        showSavedRooms(); // Refresh list
        showNotification('Room berhasil dihapus', 'success');
      }
    }

    function closeSavedRoomsModal() {
      document.getElementById('savedRoomsModal').classList.add('hidden');
    }

    // ===== AUTO-SAVE SYSTEM =====
    function startAutoSave() {
      if (window.autoSaveInterval) {
        clearInterval(window.autoSaveInterval);
      }
      
      window.autoSaveInterval = setInterval(() => {
        if (window.roomId && window.userName) {
          const sessionData = window.storageManager.getCurrentSession();
          window.storageManager.saveSession(sessionData);
        }
      }, 10000); // Every 10 seconds
    }

    function stopAutoSave() {
      if (window.autoSaveInterval) {
        clearInterval(window.autoSaveInterval);
        window.autoSaveInterval = null;
      }
    }

    // ===== NOTIFICATION SYSTEM =====
    function showNotification(message, type = "success") {
      const container = document.getElementById("notificationContainer");
      const notification = document.createElement("div");
      notification.className = `notification-toast ${type}`;
      
      const icon = type === "success" ? "✅" : type === "error" ? "❌" : "⚠️";
      notification.innerHTML = `<span>${icon}</span><span>${message}</span>`;
      
      container.appendChild(notification);
      
      if (window.soundEnabled) {
        playSound();
      }
      
      // Browser notification
      if ("Notification" in window && Notification.permission === "granted") {
        try {
          new Notification("TodoPro", { body: message, icon: "📝" });
        } catch (error) {
          console.log("Browser notification not supported");
        }
      }
      
      setTimeout(() => {
        if (notification && notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 4000);
    }

    // ===== ROOM MANAGEMENT =====
    function createRoom() {
      window.userName = document.getElementById("userName").value.trim();
      if (!window.userName) {
        showNotification("Isi nama Anda!", "error");
        return;
      }
      
      window.role = "mentor";
      window.roomId = "room-" + Math.floor(Math.random() * 10000);
      autoCreateRoom();
    }

    function joinRoom() {
      window.userName = document.getElementById("userName").value.trim();
      const newRoomId = document.getElementById("roomIdInput").value.trim();
      if (!window.userName || !newRoomId) {
        showNotification("Isi nama dan Room ID!", "error");
        return;
      }
      
      window.role = "member";
      window.roomId = newRoomId;
      autoJoinRoom();
    }

    function logout() {
      try {
        // Save current session before logout
        if (window.roomId && window.userName) {
          const sessionData = window.storageManager.getCurrentSession();
          window.storageManager.saveSession(sessionData);
        }
        
        stopAutoSave();
        
        if (window.peer) window.peer.destroy();
        if (window.conn) window.conn.close();
        if (window.connections) {
          window.connections.forEach(c => c.close());
          window.connections = [];
        }
        window.roomMembers.clear();
        
        window.userName = "";
        window.roomId = "";
        window.role = "";
        
        showNotification("Berhasil keluar dan session tersimpan", "success");
        setTimeout(() => location.reload(), 1000);
      } catch (error) {
        console.error('Error during logout:', error);
        location.reload();
      }
    }

    // ===== THEME SYSTEM =====
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", newTheme);
      try {
        localStorage.setItem("theme", newTheme);
      } catch (error) {
        console.error('Error saving theme:', error);
      }
      updateThemeToggle();
      showNotification("Tema diubah ke mode " + (newTheme === "dark" ? "gelap" : "terang"), "success");
    }

    function updateThemeToggle() {
      const toggle = document.getElementById("themeToggle");
      if (toggle) {
        toggle.textContent = document.documentElement.getAttribute("data-theme") === "dark" ? "☀️" : "🌙";
      }
    }

    // ===== SOUND SYSTEM =====
    function toggleSound() {
      window.soundEnabled = !window.soundEnabled;
      try {
        localStorage.setItem("soundEnabled", window.soundEnabled);
      } catch (error) {
        console.error('Error saving sound setting:', error);
      }
      updateSoundToggle();
      
      if (window.soundEnabled) {
        playSound();
        showNotification("Suara diaktifkan", "success");
      } else {
        showNotification("Suara dinonaktifkan", "warning");
      }
    }

    function updateSoundToggle() {
      const toggle = document.getElementById("soundToggle");
      if (toggle) {
        toggle.textContent = window.soundEnabled ? "🔊" : "🔇";
        toggle.classList.toggle("muted", !window.soundEnabled);
      }
    }

    function playSound(type = "notification") {
      if (!window.soundEnabled) return;
      
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        if (type === "assignment") {
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
          oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.2);
        } else {
          oscillator.frequency.value = 600;
        }
        
        oscillator.type = "sine";
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        console.log("Audio tidak didukung");
      }
    }

    // ===== PEER CONNECTION MANAGEMENT =====
    function autoCreateRoom() {
      try {
        window.peer = new Peer(window.roomId, {
          host: 'peerjs-server.com',
          port: 443,
          secure: true,
          config: {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" }
            ]
          }
        });

        window.peer.on('open', () => {
          showNotification(`Room ${window.roomId} berhasil dibuat!`, "success");
          setupApp();
          
          window.roomMembers.set(window.userName, {
            name: window.userName,
            role: "mentor",
            status: "online",
            joinTime: new Date()
          });
          
          updateMembersList();
          startAutoSave();
        });

        window.peer.on('connection', (conn) => {
          window.connections.push(conn);
          setupConnection(conn);
        });

        window.peer.on('error', (err) => {
          console.error('PeerJS Error:', err);
          showNotification("Gagal membuat room", "error");
        });

      } catch (error) {
        console.error('Error creating room:', error);
        showNotification("Terjadi kesalahan saat membuat room", "error");
      }
    }

    function autoJoinRoom() {
      try {
        window.peer = new Peer(window.userName + '-' + Date.now(), {
          host: 'peerjs-server.com',
          port: 443,
          secure: true,
          config: {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" }
            ]
          }
        });

        window.peer.on('open', () => {
          window.conn = window.peer.connect(window.roomId);
          setupConnection(window.conn);
          
          window.conn.on('open', () => {
            showNotification(`Berhasil bergabung ke room ${window.roomId}!`, "success");
            setupApp();
            
            // Send join message
            window.conn.send({
              type: 'user-join',
              data: {
                name: window.userName,
                role: window.role,
                joinTime: new Date()
              }
            });

            startAutoSave();
          });
        });

        window.peer.on('error', (err) => {
          console.error('PeerJS Error:', err);
          showNotification("Gagal bergabung ke room", "error");
        });

      } catch (error) {
        console.error('Error joining room:', error);
        showNotification("Terjadi kesalahan saat bergabung", "error");
      }
    }

    function setupConnection(conn) {
      conn.on('data', (data) => {
        handleMessage(data, conn);
      });

      conn.on('close', () => {
        if (window.connections.includes(conn)) {
          window.connections.splice(window.connections.indexOf(conn), 1);
        }
        updateMembersList();
      });

      conn.on('error', (err) => {
        console.error('Connection error:', err);
      });
    }

    function handleMessage(message, conn) {
      try {
        switch (message.type) {
          case 'user-join':
            window.roomMembers.set(message.data.name, {
              ...message.data,
              status: "online"
            });
            updateMembersList();
            showNotification(`${message.data.name} bergabung ke room`, "success");
            
            // Send current todos to new member
            if (window.role === "mentor") {
              const todos = loadTodos();
              conn.send({
                type: 'todos-sync',
                data: todos
              });
              
              // Send member list to new member
              conn.send({
                type: 'members-sync',
                data: Array.from(window.roomMembers.entries())
              });
            }
            break;

          case 'todos-sync':
            try {
              localStorage.setItem("todos", JSON.stringify(message.data));
              loadAndDisplayTodos();
              updateDashboard();
            } catch (error) {
              console.error('Error syncing todos:', error);
            }
            break;

          case 'todo-added':
            let todos = loadTodos();
            todos.push(message.data);
            try {
              localStorage.setItem("todos", JSON.stringify(todos));
              loadAndDisplayTodos();
              updateDashboard();
              
              if (message.data.assignedTo === window.userName || !message.data.assignedTo) {
                showNotification(`Tugas baru: ${message.data.title}`, "success");
                playSound("assignment");
              }
            } catch (error) {
              console.error('Error adding todo:', error);
            }
            break;

          case 'todo-updated':
            let allTodos = loadTodos();
            const index = allTodos.findIndex(t => t.id === message.data.id);
            if (index !== -1) {
              allTodos[index] = message.data;
              try {
                localStorage.setItem("todos", JSON.stringify(allTodos));
                loadAndDisplayTodos();
                updateDashboard();
                
                if (message.data.completed && message.data.assignedTo === window.userName) {
                  showNotification(`Anda menyelesaikan: ${message.data.title}`, "success");
                }
              } catch (error) {
                console.error('Error updating todo:', error);
              }
            }
            break;

          case 'todo-deleted':
            let remainingTodos = loadTodos().filter(t => t.id !== message.data.id);
            try {
              localStorage.setItem("todos", JSON.stringify(remainingTodos));
              loadAndDisplayTodos();
              updateDashboard();
              showNotification("Tugas dihapus", "warning");
            } catch (error) {
              console.error('Error deleting todo:', error);
            }
            break;

          case 'members-sync':
            window.roomMembers.clear();
            message.data.forEach(([name, data]) => {
              window.roomMembers.set(name, data);
            });
            updateMembersList();
            break;
        }
      } catch (error) {
        console.error('Error handling message:', error);
      }
    }

    function setupApp() {
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      
      document.getElementById("roomTitle").textContent = `🏠 Room: ${window.roomId}`;
      document.getElementById("userRole").textContent = `👤 ${window.userName} (${window.role === "mentor" ? "Mentor" : "Anggota"})`;
      document.getElementById("status").textContent = "Online";
      document.getElementById("status").className = "status online";
      
      // Show add form only for mentors
      if (window.role === "mentor") {
        document.getElementById("addTodoForm").classList.remove("hidden");
      } else {
        document.getElementById("memberInfo").classList.remove("hidden");
      }
      
      loadAndDisplayTodos();
      updateDashboard();
      updateAssigneeOptions();

      // Initialize date input
      const dateInput = document.getElementById("todoDueDate");
      if (dateInput) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        dateInput.min = now.toISOString().slice(0, 16);
      }
    }

    // ===== TODO MANAGEMENT =====
    function loadTodos() {
      try {
        return JSON.parse(localStorage.getItem("todos") || "[]");
      } catch (error) {
        console.error("Error loading todos:", error);
        return [];
      }
    }

    function addTodo() {
      if (window.role !== "mentor") {
        showNotification("Hanya mentor yang bisa menambah tugas", "error");
        return;
      }
      
      const title = document.getElementById("todoTitle").value.trim();
      const description = document.getElementById("todoDesc").value.trim();
      const priority = document.getElementById("todoPriority").value;
      const dueDate = document.getElementById("todoDueDate").value;
      const assignedTo = document.getElementById("todoAssignee").value;
      
      if (!title) {
        showNotification("Judul tugas harus diisi", "error");
        return;
      }
      
      const newTodo = {
        id: Date.now(),
        title,
        description,
        priority,
        dueDate: dueDate || null,
        assignedTo: assignedTo === "unassigned" ? null : assignedTo || null,
        completed: false,
        createdAt: new Date().toISOString(),
        createdBy: window.userName
      };
      
      // Add to local storage
      let todos = loadTodos();
      todos.push(newTodo);
      try {
        localStorage.setItem("todos", JSON.stringify(todos));
      } catch (error) {
        console.error("Error saving todos:", error);
        showNotification("Gagal menyimpan tugas", "error");
        return;
      }
      
      // Broadcast to all connections
      broadcastMessage({
        type: 'todo-added',
        data: newTodo
      });
      
      // Clear form
      document.getElementById("todoTitle").value = "";
      document.getElementById("todoDesc").value = "";
      document.getElementById("todoDueDate").value = "";
      document.getElementById("todoAssignee").value = "";
      document.getElementById("todoPriority").value = "medium";
      
      loadAndDisplayTodos();
      updateDashboard();
      showNotification("Tugas berhasil ditambahkan", "success");
    }

    function toggleTodo(id) {
      let todos = loadTodos();
      const todo = todos.find(t => t.id === id);
      
      if (!todo) return;
      
      // Only allow assigned user or mentor to toggle
      if (window.role === "member" && todo.assignedTo && todo.assignedTo !== window.userName) {
        showNotification("Anda tidak bisa mengubah tugas yang ditugaskan ke orang lain", "error");
        return;
      }
      
      todo.completed = !todo.completed;
      todo.completedAt = todo.completed ? new Date().toISOString() : null;
      todo.completedBy = todo.completed ? window.userName : null;
      
      try {
        localStorage.setItem("todos", JSON.stringify(todos));
      } catch (error) {
        console.error("Error saving todos:", error);
        showNotification("Gagal menyimpan perubahan", "error");
        return;
      }
      
      // Broadcast update
      broadcastMessage({
        type: 'todo-updated',
        data: todo
      });
      
      loadAndDisplayTodos();
      updateDashboard();
      
      if (todo.completed) {
        showNotification(`Tugas "${todo.title}" selesai! 🎉`, "success");
        playSound("assignment");
      }
    }

    function deleteTodo(id) {
      if (window.role !== "mentor") {
        showNotification("Hanya mentor yang bisa menghapus tugas", "error");
        return;
      }
      
      if (!confirm("Hapus tugas ini?")) return;
      
      let todos = loadTodos();
      todos = todos.filter(t => t.id !== id);
      
      try {
        localStorage.setItem("todos", JSON.stringify(todos));
      } catch (error) {
        console.error("Error saving todos:", error);
        showNotification("Gagal menghapus tugas", "error");
        return;
      }
      
      // Broadcast deletion
      broadcastMessage({
        type: 'todo-deleted',
        data: { id }
      });
      
      loadAndDisplayTodos();
      updateDashboard();
      showNotification("Tugas berhasil dihapus", "success");
    }

    function broadcastMessage(message) {
      try {
        if (window.connections && window.connections.length > 0) {
          window.connections.forEach(conn => {
            if (conn && conn.open) {
              try {
                conn.send(message);
              } catch (error) {
                console.error('Error sending message to connection:', error);
              }
            }
          });
        } else if (window.conn && window.conn.open) {
          try {
            window.conn.send(message);
          } catch (error) {
            console.error('Error sending message:', error);
          }
        }
      } catch (error) {
        console.error('Error in broadcastMessage:', error);
      }
    }

    // ===== UI MANAGEMENT =====
    function loadAndDisplayTodos() {
      const todos = loadTodos();
      const now = new Date();
      
      // Categorize todos
      const overdue = todos.filter(t => !t.completed && t.dueDate && new Date(t.dueDate) < now);
      const inbox = todos.filter(t => !t.completed && (!t.dueDate || new Date(t.dueDate) >= now));
      const completed = todos.filter(t => t.completed);
      
      // Update counts
      document.getElementById("overdueCount").textContent = overdue.length;
      document.getElementById("inboxCount").textContent = inbox.length;
      document.getElementById("completedCount").textContent = completed.length;
      
      // Display todos
      displayTodoSection("overdueTasks", overdue);
      displayTodoSection("inboxTasks", inbox);
      displayTodoSection("completedTasks", completed);
      
      // Show/hide empty state
      const isEmpty = todos.length === 0;
      document.getElementById("emptyState").style.display = isEmpty ? "block" : "none";
    }

    function displayTodoSection(containerId, todos) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = "";
      
      const filteredTodos = filterTodosBySearch(todos);
      
      filteredTodos.forEach(todo => {
        const todoElement = createTodoElement(todo);
        container.appendChild(todoElement);
      });
    }

    function createTodoElement(todo) {
      const div = document.createElement("div");
      div.className = `todo-item ${todo.completed ? "completed" : ""} priority-${todo.priority}`;
      if (todo.dueDate && new Date(todo.dueDate) < new Date() && !todo.completed) {
        div.classList.add("priority-overdue");
      }
      
      const assignmentInfo = todo.assignedTo ? `
        <span class="assignment-badge">👤 ${todo.assignedTo}</span>
      ` : "";
      
      const dueDateInfo = todo.dueDate ? `
        <span class="due-date-badge ${getDueDateClass(todo.dueDate, todo.completed)}">
          🗓️ ${formatDueDate(todo.dueDate)}
        </span>
      ` : "";
      
      const priorityBadge = `
        <span class="priority-badge ${todo.priority}">${getPriorityIcon(todo.priority)} ${todo.priority.toUpperCase()}</span>
      `;
      
      div.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
          <strong>${todo.title}</strong>
          ${window.role === "mentor" ? `<button onclick="deleteTodo(${todo.id})" style="background: var(--danger-color); padding: 0.25rem 0.5rem; font-size: 0.8rem;">🗑️</button>` : ""}
        </div>
        
        ${todo.description ? `<p style="color: var(--text-secondary); margin-bottom: 0.5rem;">${todo.description}</p>` : ""}
        
        <div style="margin-bottom: 0.5rem;">
          ${priorityBadge}${assignmentInfo}${dueDateInfo}
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary);">
          <span>Dibuat: ${new Date(todo.createdAt).toLocaleString('id-ID')}</span>
          ${todo.completed ? `<span>✅ Selesai: ${new Date(todo.completedAt).toLocaleString('id-ID')}</span>` : ""}
        </div>
        
        <div style="margin-top: 1rem;">
          <input type="checkbox" ${todo.completed ? "checked" : ""} 
                 onchange="toggleTodo(${todo.id})" 
                 style="margin-right: 0.5rem; transform: scale(1.2);">
          <label>${todo.completed ? "Selesai" : "Tandai Selesai"}</label>
        </div>
      `;
      
      return div;
    }

    function getPriorityIcon(priority) {
      switch (priority) {
        case "high": return "🔴";
        case "medium": return "🟡";
        case "low": return "🟢";
        default: return "⚪";
      }
    }

    function getDueDateClass(dueDate, completed) {
      if (completed) return "";
      
      const due = new Date(dueDate);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
      
      if (due < today) return "overdue";
      if (due.toDateString() === today.toDateString()) return "today";
      if (due.toDateString() === tomorrow.toDateString()) return "tomorrow";
      return "";
    }

    function formatDueDate(dueDate) {
      const date = new Date(dueDate);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      if (date < today) return "Terlambat";
      if (date.toDateString() === today.toDateString()) return "Hari ini";
      if (date.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString()) return "Besok";
      
      return date.toLocaleDateString('id-ID');
    }

    function filterTodosBySearch(todos) {
      const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";
      const assigneeFilter = document.getElementById("assigneeFilter")?.value || "all";
      
      return todos.filter(todo => {
        const matchesSearch = !searchTerm || 
          todo.title.toLowerCase().includes(searchTerm) ||
          (todo.description && todo.description.toLowerCase().includes(searchTerm));
        
        const matchesAssignee = assigneeFilter === "all" ||
          (assigneeFilter === "assigned-to-me" && (todo.assignedTo === window.userName || (!todo.assignedTo && window.role === "mentor"))) ||
          (assigneeFilter === "unassigned" && !todo.assignedTo);
        
        return matchesSearch && matchesAssignee;
      });
    }

    function filterTasks() {
      loadAndDisplayTodos();
    }

    function updateDashboard() {
      const todos = loadTodos();
      const myTodos = todos.filter(t => 
        t.assignedTo === window.userName || 
        (window.role === "mentor" && !t.assignedTo)
      );
      
      const completed = todos.filter(t => t.completed);
      const overdue = todos.filter(t => !t.completed && t.dueDate && new Date(t.dueDate) < new Date());
      
      document.getElementById("totalTasks").textContent = todos.length;
      document.getElementById("completedTasks").textContent = completed.length;
      document.getElementById("completionRate").textContent = todos.length > 0 ? Math.round((completed.length / todos.length) * 100) + "%" : "0%";
      document.getElementById("overdueTasks").textContent = overdue.length;
      document.getElementById("assignedToMe").textContent = myTodos.length;
    }

    function updateAssigneeOptions() {
      const select = document.getElementById("todoAssignee");
      if (!select) return;
      
      // Clear existing options except default ones
      while (select.children.length > 2) {
        select.removeChild(select.lastChild);
      }
      
      // Add members as options
      window.roomMembers.forEach((member, name) => {
        if (member.role === "member") {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = `👤 ${name}`;
          select.appendChild(option);
        }
      });
    }

    function updateMembersList() {
      const container = document.getElementById("memberList");
      if (!container) return;
      
      container.innerHTML = "";
      
      window.roomMembers.forEach((member, name) => {
        const chip = document.createElement("div");
        chip.className = `member-chip ${member.role}`;
        
        chip.innerHTML = `
          <div class="status-dot ${member.status}"></div>
          <span>${name}</span>
          ${member.role === "mentor" ? "👑" : ""}
        `;
        
        container.appendChild(chip);
      });
      
      updateAssigneeOptions();
    }

    // ===== EVENT HANDLERS =====
    function handleModalClick(event, modalId) {
      if (event.target.id === modalId) {
        if (modalId === 'restoreModal') {
          closeRestoreModal();
        } else if (modalId === 'savedRoomsModal') {
          closeSavedRoomsModal();
        }
      }
    }

    // ===== INITIALIZATION =====
    // Enhanced DOM Ready Handling with multiple fallbacks
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else if (document.readyState === 'interactive') {
      setTimeout(initializeApp, 0);
    } else {
      initializeApp();
    }

    // Fallback initialization
    window.addEventListener('load', function() {
      if (!window.appInitialized) {
        console.log('Fallback initialization');
        initializeApp();
      }
    });

    // Add event listeners for modals
    document.addEventListener('click', function(event) {
      if (event.target.id === 'restoreModal') {
        closeRestoreModal();
      } else if (event.target.id === 'savedRoomsModal') {
        closeSavedRoomsModal();
      }
    });

    // Prevent memory leaks on page unload
    window.addEventListener('beforeunload', function() {
      try {
        // Save session before unload
        if (window.roomId && window.userName) {
          const sessionData = window.storageManager.getCurrentSession();
          window.storageManager.saveSession(sessionData);
        }
        
        // Cleanup
        stopAutoSave();
        if (window.peer) window.peer.destroy();
        if (window.conn) window.conn.close();
        if (window.connections) {
          window.connections.forEach(c => c.close());
        }
      } catch (error) {
        console.error('Error during cleanup:', error);
      }
    });

    // Error handling for uncaught errors
    window.addEventListener('error', function(event) {
      console.error('Global error:', event.error);
      showNotification('Terjadi kesalahan aplikasi', 'error');
    });

    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });

    // Mark app as initialized
    window.appInitialized = true;
  </script>

</body>
</html>
